%% Estimate the estrinsic parameters of the laser projector
clear all
close all
clc
% Vector of poses Tcam mark - dataset
Tcm1 = [ -0.00807289     0.99985  -0.0152963   -0.131446
  -0.999341 -0.00860837  -0.0352705  -0.0310314
 -0.0353969   0.0150015    0.999261     1.63022 ];

Tcm2 = [ -0.0118214    0.999894 -0.00854065   -0.117591
  -0.997641  -0.0123716  -0.0675224  -0.0148853
 -0.0676209  0.00772229    0.997681    0.855386];

% fake poses
% computed as follows:
% Rcp = eval(Rypr) and traslation is arbitary


% alfa =  40  *pi/180;
% beta  =   -15*pi/180;
% gamma =  70*pi/180;
Tcm3 = [
    0.7399    0.0335   -0.6718    1.0000
   -0.6209    0.4183   -0.6629    0.3000
    0.2588    0.9077    0.3304    4.7000
    ];


% alfa =  19  *pi/180;
% beta  =   -35*pi/180;
% gamma = 0*pi/180;
Tcm4 = [
     0.7745   -0.3256   -0.5423 -0.11
    0.2667    0.9455   -0.1867 -0.028
    0.5736         0    0.8192 -4
    ];

% alfa =  0  *pi/180;
% beta  =   3*pi/180;
% gamma = 19*pi/180;
Tcm5 = [
    0.9986    0.0170    0.0495 1.0012
         0    0.9455   -0.3256 0.0003
   -0.0523    0.3251    0.9442 3.7851
];

% Tcm6 first version
% alfa =  40*pi/180;
% % beta  =   -9.76*pi/180;
% % gamma = -7.6*pi/180;
Tcm6 = [
    0.7550   -0.6200   -0.2137 1.6749
    0.6335    0.7737   -0.0067 -0.0011
    0.1695   -0.1303    0.9769 0.0
    ];

% alfa =  40*pi/180;
% beta  =   -9.76*pi/180;
% gamma = -7.6*pi/180;
% Tcm6 = [
%     0.7550   -0.6200   -0.2137 1.6749
%     0.6335    0.7737   -0.0067 -0.0011
%     0.1695   -0.1303    0.9769 0.0
%     ];
% Tcm31 first version
% alfa =  0.5  *pi/180;
% beta  =   15*pi/180;
% gamma = 7 *pi/180;
Tcm7 = [
    0.9659    0.0229    0.2579 0.17
    0.0084    0.9928   -0.1196 -0.03 
   -0.2588    0.1177    0.9587 2
    ];

% Marker's frame 3D points [m] -> when i backproject these points with manual calibration i get 0,0 in uv coords 
P1 = [  0.0165    0.4546  0 ]; % according to Tcm1
P2 = [ -0.0012    0.3059  0 ]; % Tcm2
%P3 = [ -0.524049489587776   -1.757180057978853       0]; % Tcm31
P3 = [ -0.5240   -1.7572   0]; % Tcm31
P4 = [ -0.5993    0.4204  0 ]; %Tcm4
P5 = [ -0.3104   -0.1524  0 ]; %Tcm5
P6 = [ -1.3220    1.1307  0 ]; %Tcm61 first version
P7 = [  0.2136   -0.0368  0 ]; % Tcm31 first version

% A1 = tcm1 + Xm*rcm11 + Ym*rcm12 + Zm*rcm13
% B1 = tcm2 + Xm*rcm21 + Ym*rcm22 + Zm*rcm23
% C1 = tcm3 + Xm*rcm31 + Ym*rcm32 + Zm*rcm33

A1 = Tcm1(1,4) + P1(1)*Tcm1(1,1) + P1(2)*Tcm1(1,2) + P1(3)*Tcm1(1,3);
B1 = Tcm1(2,4) + P1(1)*Tcm1(2,1) + P1(2)*Tcm1(2,2) + P1(3)*Tcm1(2,3);
C1 = Tcm1(3,4) + P1(1)*Tcm1(3,1) + P1(2)*Tcm1(3,2) + P1(3)*Tcm1(3,3);

A2 = Tcm2(1,4) + P2(1)*Tcm2(1,1) + P2(2)*Tcm2(1,2) + P2(3)*Tcm2(1,3);
B2 = Tcm2(2,4) + P2(1)*Tcm2(2,1) + P2(2)*Tcm2(2,2) + P2(3)*Tcm2(2,3);
C2 = Tcm2(3,4) + P2(1)*Tcm2(3,1) + P2(2)*Tcm2(3,2) + P2(3)*Tcm2(3,3);

A3 = Tcm3(1,4) + P3(1)*Tcm3(1,1) + P3(2)*Tcm3(1,2) + P3(3)*Tcm3(1,3);
B3 = Tcm3(2,4) + P3(1)*Tcm3(2,1) + P3(2)*Tcm3(2,2) + P3(3)*Tcm3(2,3);
C3 = Tcm3(3,4) + P3(1)*Tcm3(3,1) + P3(2)*Tcm3(3,2) + P3(3)*Tcm3(3,3);

A4 = Tcm4(1,4) + P4(1)*Tcm4(1,1) + P4(2)*Tcm4(1,2) + P4(3)*Tcm4(1,3);
B4 = Tcm4(2,4) + P4(1)*Tcm4(2,1) + P4(2)*Tcm4(2,2) + P4(3)*Tcm4(2,3);
C4 = Tcm4(3,4) + P4(1)*Tcm4(3,1) + P4(2)*Tcm4(3,2) + P4(3)*Tcm4(3,3);

A5 = Tcm5(1,4) + P5(1)*Tcm5(1,1) + P5(2)*Tcm5(1,2) + P5(3)*Tcm5(1,3);
B5 = Tcm5(2,4) + P5(1)*Tcm5(2,1) + P5(2)*Tcm5(2,2) + P5(3)*Tcm5(2,3);
C5 = Tcm5(3,4) + P5(1)*Tcm5(3,1) + P5(2)*Tcm5(3,2) + P5(3)*Tcm5(3,3);

A6 = Tcm6(1,4) + P6(1)*Tcm6(1,1) + P6(2)*Tcm6(1,2) + P6(3)*Tcm6(1,3);
B6 = Tcm6(2,4) + P6(1)*Tcm6(2,1) + P6(2)*Tcm6(2,2) + P6(3)*Tcm6(2,3);
C6 = Tcm6(3,4) + P6(1)*Tcm6(3,1) + P6(2)*Tcm6(3,2) + P6(3)*Tcm6(3,3);

A7 = Tcm7(1,4) + P7(1)*Tcm7(1,1) + P7(2)*Tcm7(1,2) + P7(3)*Tcm7(1,3);
B7 = Tcm7(2,4) + P7(1)*Tcm7(2,1) + P7(2)*Tcm7(2,2) + P7(3)*Tcm7(2,3);
C7 = Tcm7(3,4) + P7(1)*Tcm7(3,1) + P7(2)*Tcm7(3,2) + P7(3)*Tcm7(3,3);

% 1 and 3 poses are not good beacuse are almost linear dipendent

A = [ 
     A1 B1 C1 1 0  0  0  0 0  0  0  0 ;
      0  0  0  0 A1 B1 C1 1 0  0  0  0 ;
      0  0  0  0 0  0  0  0 A1 B1 C1 1
     A2 B2 C1 1 0  0  0  0 0  0  0  0 ;
      0  0  0  0 A2 B2 C2 1 0  0  0  0 ;
      0  0  0  0 0  0  0  0 A2 B2 C2 1; 
      A3 B3 C3 1 0  0  0  0 0  0  0  0 ;
      0  0  0  0 A3 B3 C3 1 0  0  0  0 ;
     0  0  0  0 0  0  0  0 A3 B3 C3 1 
       A4 B4 C4 1 0  0  0  0 0  0  0  0 ;
      0  0  0  0 A4 B4 C4 1 0  0  0  0 ; 
      0  0  0  0 0  0  0 0 A4  B4 C4 1 ;
%       A5 B5 C5 1 0  0  0  0 0  0  0  0 ;
%       0  0  0  0 A5 B5 C5 1 0  0  0  0 ;
%       0  0  0  0 0  0  0  0 A5 B5 C5 1 
%       A6 B6 C6 1 0  0  0  0 0  0  0  0 ;
%       0  0  0  0 A6 B6 C6 1 0  0  0  0 ; 
%       0  0  0  0 0  0  0 0 A6  B6 C6 1 ;
%       A7 B7 C7 1 0  0  0  0 0  0  0  0 ;
%       0  0  0  0 A7 B7 C7 1 0  0  0  0 ;
%       0  0  0  0 0  0  0  0 A7 B7 C7 1 
]

% b = [0;0;1.6623;0;0;0.8714;0;0;3.0162;0;0;-4.4123]%;0;0;1;0;0;1;0;0;1];
b = [0;0;1;0;0;1;0;0;1;0;0;1];
%b = [0;0;1.66236876183732;0;0;0.871431447329316;0;0;3.01636259654000;0;0;-4.41236440714800]%;0;0;1;0;0;1;0;0;1];
% b = [0;0;1.66236876183732;0;0;0.871431447329316;0;0;3.01636259654000;0;0;-4.41236440714800]%;0;0;1;0;0;1;0;0;1];
% b = [0;0;1.66236876183732;0;0;0.871431447329316;0;0;3.016225611538408;0;0;-4.41236440714800]%;0;0;1;0;0;1;0;0;1];

% 3.016225611538408

bb = [
    3.29920095180035e-05;
    5.94308325862145e-05;
    1.66236876183732;
    -0.0338943349642200;
    -1.85789945340367e-05;
    0.871431447329316;
    0.000110578344000047;
    0.000140186095999938;
    3.01636259654000;
    -5.73653820000082e-05;
    -0.000268516899999995;
    -4.41236440714800
    ];
    

Tpc =[

    0.0000   -0.9990   -0.0436    0.0200
    0.9854    0.0074   -0.1700   -0.0396
    0.1702   -0.0430    0.9845   -0.0059
        0           0       0       1];


Tcp =[
   -0.0000    0.9854    0.1702    0.0400
   -0.9991    0.0074   -0.0430    0.0200
   -0.0436   -0.1700    0.9845   -0.0001
         0         0         0    1.0000];    
Rcp_real = [ 
   -0.0000    0.9854    0.1702
   -0.9991    0.0074   -0.0430   
   -0.0436   -0.1700    0.9845
];
     
% this is actually what are we looking for (Tpc)
xk1 =[
         0
   -0.9990
   -0.0436
    0.0200
    0.9854
    0.0074
   -0.1700
   -0.0396
    0.1702
   -0.0430
    0.9845
   -0.0059
         ];

% xk2 =[
%          0
%     0.9854
%     0.1702
%     0.0400
%     -0.9990
%     0.0074
%    -0.0430
%     0.0200
%    -0.0436
%    -0.1700
%     0.9845
%     0.0001
%          ];

Ared = [ 
      A1 B1 C1 1 0  0  0  0 0  0  0  0 ;
      0  0  0  0 A1 B1 C1 1 0  0  0  0 ;
      

      ];

x =  A \ b

% uv_proj = Ared*xk1